// ==UserScript==
// @name         ArkTrpg
// @author       泰拉旅社
// @version      1.0.0
// @description  适配WIT-v1.0的规则检定
// @timestamp    1744133414
// ==/UserScript==
(()=>{var g={"\u6B3A\u8BC8\uFF0C\u4E54\u88C5\uFF0C\u6F5C\u884C\uFF0C\u8C03\u67E5\uFF0C\u89C9\u5BDF\uFF0C\u8FFD\u8E2A":"\u7CBE\u795E\u610F\u5FD7","\u58F0\u4E50\uFF0C\u827A\u672F\uFF0C\u5FC3\u7406\uFF0C\u6E38\u8BF4\uFF0C\u53D6\u60A6\uFF0C\u5A01\u5413":"\u4E2A\u4EBA\u9B45\u529B","\u5999\u624B\uFF0C\u6025\u6551\uFF0C\u9A7E\u9A76\uFF0C\u821E\u8E48\uFF0C\u77ED\u5175\uFF0C\u6697\u5668\uFF0C\u5C04\u51FB\uFF0C\u8EAB\u6CD5":"\u53CD\u5E94\u673A\u52A8","\u957F\u5175\uFF0C\u5200\u5251\uFF0C\u949D\u5668\uFF0C\u683C\u6597\uFF0C\u8F6F\u5175\uFF0C\u62F3\u672F\uFF0C\u76FE\u672F":"\u7269\u7406\u5F3A\u5EA6","\u5175\u68B0\u64CD\u4F5C\uFF0C\u751F\u7269\u9A6F\u517B\uFF0C\u6218\u672F\u89C4\u5212\uFF0C\u652F\u63F4\u6280\u672F\uFF0C\u81EA\u7136\u5B66\uFF0C\u533B\u836F\u5B66\uFF0C\u6E90\u77F3\u5B66\uFF0C\u793E\u4F1A\u5B66\uFF0C\u653F\u6CD5\u5B66\uFF0C\u7ECF\u7BA1\u5B66\uFF0C\u673A\u68B0\u5DE5\u7A0B\uFF0C\u7535\u5B50\u5DE5\u7A0B\uFF0C\u519C\u6797\u6E14\u7267\uFF0C\u624B\u5DE5\u5DE5\u827A":"\u7ECF\u9A8C\u667A\u6167","\u52A8\u80FD\uFF0C\u5149\u660E\uFF0C\u6697\u5F71\uFF0C\u706B\u7130\uFF0C\u7535\u80FD\uFF0C\u6C14\u6D41\uFF0C\u63A7\u6C34\uFF0C\u571F\u77F3\uFF0C\u51B0\u971C\uFF0C\u8EAF\u4F53\uFF0C\u690D\u7269\uFF0C\u6062\u590D\uFF0C\u4F20\u5FC3\u611F\u77E5":"\u6E90\u77F3\u6280\u827A\u9002\u5E94\u6027"};function M(e,r){let t=/[\.。]rk\s*(\d*)\s*([^\d\s/]*)\s*(\d*)\s*\/(\d+)/,n=r.match(t);if(r.includes("/")&&(!n||!n[4]||n[4]===""))return{success:!1,errorMsg:"\u9519\u8BEF\uFF1A\u6307\u5B9A\u4E86/\u7B26\u53F7\u4F46\u672A\u63D0\u4F9B\u96BE\u5EA6\u7B49\u7EA7DC\xD7"};let s,l,a,c;if(n)[,s,l,a,c]=n;else{let o=/[\.。]rk\s*(\d*)\s*([^\d\s/]*)\s*(\d*)/,u=r.match(o);if(!u)return{success:!1,errorMsg:"\u9519\u8BEF\uFF1A\u547D\u4EE4\u683C\u5F0F\u4E0D\u6B63\u786E\xD7"};[,s,l,a]=u,c="0"}return!l||l===""?{success:!1,errorMsg:"\u9519\u8BEF\uFF1A\u672A\u63D0\u4F9B\u6280\u80FD\u540D\xD7"}:(s=s&&s.length>0?parseInt(s):6,a=a&&a.length>0?parseInt(a):d(e,l,0),c=parseInt(c)||0,{success:!0,face:s,skillName:l,skillValue:a,dcValue:c,atQq:null})}function R(e){if(e.match(/^[\.。]rkb/)){let r=e.match(/^[\.。]rkb(\d*)/),t=r&&r[1]&&r[1].length>0?parseInt(r[1]):1;return e=e.replace(/^[\.。]rkb(\d*)/,".rk"),[e,t]}if(e.match(/^[\.。]rkp/)){let r=e.match(/^[\.。]rkp(\d*)/),t=r&&r[1]&&r[1].length>0?parseInt(r[1]):1;return e=e.replace(/^[\.。]rkp(\d*)/,".rk"),[e,-t]}return[e,0]}function d(e,r,t){let[n,s]=seal.vars.intGet(e,r);return s?n:t}function S(e,r,t){return seal.vars.intSet(e,r,t),[t,!0]}function C(e,r,t){let n=0,s=[];for(let l=0;l<r;l++){let a=parseInt(seal.format(e,`{1d${t}}`));s.push(a),n+=a}return{values:s,sum:n}}function T(e,r){let t=e.values,n=t.length,s=0,l=0;for(let u of t)u===r?s++:u===1&&l++;let a=Math.ceil(n/2),c=s>=a,o=l>=a;return{criticalSuccess:c,criticalFailure:o}}function b(e){for(let[r,t]of Object.entries(g))if(r.includes(e))return t;return null}function x(e){for(let r of Object.values(g))if(r===e)return r;return null}function V(){let e=seal.ext.find("ArkTrpg-1.0");e||(e=seal.ext.new("ArkTrpg-1.0","\u6CF0\u62C9\u65C5\u793E","1.0.0"),seal.ext.register(e));let r=seal.ext.newCmdItemInfo();r.name="rk",r.allowDelegate=!0;let t=seal.ext.newCmdItemInfo();t.name="sck";let n=seal.ext.newCmdItemInfo();n.name="ark",r.solve=(s,l,a)=>{var m;let c=(m=a.at[0])==null?void 0:m.userId,o=null;c&&(c=c.match(/QQ:(\d+)/)[0],o=seal.getCtxProxyFirst(s,a));let u=l.message,f=y(s,o,u,c);return seal.replyToSender(s,l,f),seal.ext.newCmdExecuteResult(!0)},t.solve=(s,l)=>{let a=l.message,c=v(s,a);return seal.replyToSender(s,l,c),seal.ext.newCmdExecuteResult(!0)},n.solve=(s,l,a)=>{let c=a.getArgN(1),o=parseInt(c);if(o=isNaN(o)?1:o,o>=10)return seal.replyToSender(s,l,"\u9AB0\u70B9\u6B21\u6570\u8FC7\u591A\uFF0C\u4E0D\u53EF\u8D85\u8FC710\u6B21"),seal.ext.newCmdExecuteResult(!0);let u=seal.format(s,`{$t\u73A9\u5BB6}\u7684\u6CF0\u62C9\u4EBA\u4F5C\u6210
`),f=seal.formatTmpl(s,"COC:\u5236\u5361_\u5206\u9694\u7B26");for(let m=0;m<o;m++){let $=seal.format(s,`\u751F\u7406\u8010\u53D7\uFF1A{$t\u751F\u7406\u8010\u53D7=2d4}  \u53CD\u5E94\u673A\u52A8\uFF1A{$t\u53CD\u5E94\u673A\u52A8=2d4}
\u7269\u7406\u5F3A\u5EA6\uFF1A{$t\u7269\u7406\u5F3A\u5EA6=2d4}  \u7CBE\u795E\u610F\u5FD7\uFF1A{$t\u7CBE\u795E\u610F\u5FD7=2d4}
\u7ECF\u9A8C\u667A\u6167\uFF1A{$t\u7ECF\u9A8C\u667A\u6167=2d4}  \u6E90\u77F3\u6280\u827A\u9002\u5E94\u6027\uFF1A{$t\u6E90\u77F3\u6280\u827A\u9002\u5E94\u6027=2d4}
\u4E2A\u4EBA\u9B45\u529B\uFF1A{$t\u4E2A\u4EBA\u9B45\u529B=2d4}  \u7ECF\u6D4E\u8BC4\u7EA7\uFF1A{$t\u7ECF\u6D4E\u8BC4\u7EA7=4d6}
\u793E\u4EA4\u70B9\u6570\uFF1A{$t\u793E\u4EA4\u70B9\u6570=($t\u4E2A\u4EBA\u9B45\u529B)d6}  \u603B\u8BA1\uFF1A{$t\u4E0D\u542B\u7ECF\u6D4E\u793E\u4EA4=$t\u751F\u7406\u8010\u53D7+$t\u53CD\u5E94\u673A\u52A8+$t\u7269\u7406\u5F3A\u5EA6+$t\u7CBE\u795E\u610F\u5FD7+$t\u7ECF\u9A8C\u667A\u6167+$t\u6E90\u77F3\u6280\u827A\u9002\u5E94\u6027+$t\u4E2A\u4EBA\u9B45\u529B}/{$t\u4E0D\u542B\u7ECF\u6D4E\u793E\u4EA4+$t\u7ECF\u6D4E\u8BC4\u7EA7+$t\u793E\u4EA4\u70B9\u6570}`);u=u+$+f}return seal.replyToSender(s,l,u),seal.ext.newCmdExecuteResult(!0)},e.cmdMap.rk=r,e.cmdMap.sck=t,e.cmdMap.ark=n}V();function y(e,r,t,n){let s;[t,s]=R(t);let l=M(e,t);return l.success?(l.atQq=n,w(e,r,l,s)):l.errorMsg}function w(e,r,t,n){let s=C(e,t.skillValue+n,t.face),l=s.sum,a=s.values.join("+"),c=l,o=0;if(!x(t.skillName)){let i=b(t.skillName);o=i?d(e,i,0):0,c=c+o}let u="",f=seal.format(e,`{$t\u73A9\u5BB6}\u8FDB\u884Cark\u7684${t.skillName}\u68C0\u5B9A`),m=seal.formatTmpl(e,"COC:\u5224\u5B9A_\u6210\u529F_\u666E\u901A"),$=seal.formatTmpl(e,"COC:\u5224\u5B9A_\u5931\u8D25"),I=seal.formatTmpl(e,"COC:\u5224\u5B9A_\u5927\u6210\u529F"),A=seal.formatTmpl(e,"COC:\u5224\u5B9A_\u5927\u5931\u8D25"),k=n>=0?"+"+n:n.toString();if(c>=t.dcValue){if(u=`${f}\uFF1A
(${t.skillValue}${k})d${t.face}+${o}=${a}+${o}=${c}/${t.dcValue}\uFF0C${m}`,r){let i=d(r,"hp",0),h=c-t.dcValue;i=i-h,i<=0?(i=0,u+=`
\u63D0\u793A\uFF1A\u76EE\u6807hp\u5DF2\u7ECF\u5F52\u96F6`):u+=`
\u76EE\u6807hp\u5DF2\u51CF\u5C11${h}\u70B9`,S(r,"hp",i)}}else u=`${f}\uFF1A
(${t.skillValue}${k})d${t.face}+${o}=${a}+${o}=${c}/${t.dcValue}\uFF0C${$}`;let p=T(s,t.face);return p.criticalSuccess?u+=`
${I}\uFF08\u81F3\u5C11\u534A\u6570\u6700\u5927\u503C\uFF09`:p.criticalFailure&&(u+=`
${A}\uFF08\u81F3\u5C11\u534A\u6570\u6700\u5C0F\u503C\uFF09`),u}function v(e,r){let t=r.match(/[\.。]sck\s*(\d*)/),n=t&&t[1]&&t[1].length>0?parseInt(t[1]):1,l=C(e,n,10).sum,a=d(e,"\u7CBE\u795E\u610F\u5FD7",0),c=seal.format(e,"{$t\u73A9\u5BB6}\u8FDB\u884Cark\u7684\u81EA\u63A7\u68C0\u5B9A"),o=seal.formatTmpl(e,"COC:\u5224\u5B9A_\u6210\u529F_\u666E\u901A"),u=seal.formatTmpl(e,"COC:\u5224\u5B9A_\u5931\u8D25");return l>a?`${c}\uFF1A
${n}d10=${l}/${a}\uFF0C${u}`:`${c}\uFF1A
${n}d10=${l}/${a}\uFF0C${o}`}})();
